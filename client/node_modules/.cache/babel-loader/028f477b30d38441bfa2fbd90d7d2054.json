{"ast":null,"code":"'use strict';\n\nvar request = require('request'),\n    cheerio = require('cheerio'),\n    Promise = require('bluebird'),\n    EventEmitter = require('events'),\n    util = require('util');\n\nfunction Scraper() {\n  EventEmitter.call(this);\n}\n\nutil.inherits(Scraper, EventEmitter);\n/**\n * Get the image src for all links, options.keyword is required.\n */\n\nScraper.prototype.list = function (options) {\n  var self = this;\n  if (!options || !options.keyword) return Promise.reject(new Error('no keyword provided'));\n  var roptions = {\n    'url': 'http://www.bing.com/images/search?q=%&view=detailv2'.replace('%', encodeURIComponent(options.keyword)),\n    'User-Agent': options.userAgent || 'Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/41.0.2228.0 Safari/537.36'\n  };\n  var result = [],\n      num = options.num;\n\n  var extract = function extract(url) {\n    return new Promise(function (resolve) {\n      roptions.url = url;\n      request(roptions, function (err, response, body) {\n        if (!err && response.statusCode === 200) {\n          // extract all items, go to next page if exist\n          var $ = cheerio.load(body);\n          $('.item a[class=\"thumb\"]').each(function (el) {\n            var item = $(this).attr('href');\n            var detail = $(this).parent().find('.fileInfo').text();\n            item = {\n              url: item,\n              thumb: $(this).find('img').attr('src'),\n              width: detail.split(' ')[0],\n              height: detail.split(' ')[2],\n              format: detail.split(' ')[3],\n              size: detail.split(' ')[4],\n              unit: detail.split(' ')[5]\n            };\n            self.emit('result', item);\n            result.push(item);\n          });\n\n          if (num && result.length > num) {\n            var out = result.slice(0, num);\n            self.emit('end', out);\n            return resolve(result.slice(0, num));\n          } // search for current page and select next one\n\n\n          var page = $('li a[class=\"sb_pagS\"]').parent().next().find('a').attr('href');\n\n          if (page) {\n            resolve(extract('http://www.bing.com' + page + '&view=detailv2'));\n          } else {\n            self.emit('end', result);\n            resolve(result);\n          }\n        } else {\n          self.emit('end', result);\n          resolve(result);\n        }\n      });\n    });\n  };\n\n  return extract(roptions.url);\n};\n\nmodule.exports = Scraper;","map":null,"metadata":{},"sourceType":"script"}